<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大眾運輸查詢系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
</head>

<body>

    <div id="app">

        <nav class="navbar navbar-dark bg-dark sticky-top p-2">
            <div style="width: 100%;text-align: center;" class="p-2">
                <a class="navbar-brand" style="flex:1 0 auto;" id="header">Loading</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasDarkNavbar" style="  
                    position:absolute;
                    left:0.5rem;
                    top:0.5rem;
                    padding:5px;" aria-controls="offcanvasDarkNavbar">
                    <span class="navbar-toggler-icon"></span>
                </button>

            </div>
        </nav>
        <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="offcanvasDarkNavbar"
            aria-labelledby="offcanvasDarkNavbarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasDarkNavbarLabel">功能表 </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                    aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">


                    <ul class="list-group mb-1" id="toolbar-1" style="cursor: pointer;">
                        <li class="list-group-item list-group-item-dark" data-bs-dismiss="offcanvas"
                            onclick="App('TRAsearch')">台鐵</li>
                        <li class="list-group-item list-group-item-dark" data-bs-dismiss="offcanvas">高鐵</li>
                        <li class="list-group-item list-group-item-dark" data-bs-dismiss="offcanvas">捷運</li>

                        <li class="list-group-item list-group-item-dark" data-bs-dismiss="offcanvas">公路客運</li>
                        <li class="list-group-item list-group-item-dark" data-bs-dismiss="offcanvas">市區客運</li>
                        <li class="list-group-item list-group-item-dark" data-bs-dismiss="offcanvas">共享單車</li>
                    </ul>
                    <ul class="list-group mb-1" id="toolbar-2" style="cursor: pointer;">
                        <li class="list-group-item list-group-item-dark" data-bs-dismiss="offcanvas">已加星號</li>
                        <li class="list-group-item list-group-item-dark" data-bs-dismiss="offcanvas">歷史紀錄</li>
                    </ul>
                </ul>
            </div>
        </div>
        <div class="alert alert-info" id="loading-info">資料讀取中...</div>
        <div id="main-content" class="p-3">
            資料讀取中...
        </div>


    </div>
    <div id="req_header" hidden></div>
    <!--BS JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <!--Jquery-->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js'></script>

    <!--Main script-->
    <script>


        //date -> formated str (y/m/d)
        //time -> formated str (h:m:s)
        //pack -> {year,month,date,day,hour,minute,second}
        function getTime(type) {
            var DATE = new Date(),
                year = DATE.getFullYear(),
                mont = DATE.getMonth() + 1,
                date = DATE.getDate(),
                day = DATE.getDay(),
                //--------------------//
                hour = DATE.getHours(),
                mins = DATE.getMinutes(),
                secs = DATE.getSeconds();

            if (type == "date") {
                return `${year} / ${mont} / ${date}`
            } else
                if (type == "time") {
                    return `${hour > 9 ? hour : '0' + hour} : ${mins > 9 ? mins : '0' + mins} : ${secs > 9 ? secs : '0' + secs}`
                } else
                    if (type == "pack") {
                        let par = {
                            "year": year,
                            "month": mont,
                            "date": date,
                            "day": day,
                            "hour": hour > 9 ? hour : '0' + hour,
                            "minute": mins > 9 ? mins : '0' + mins,
                            "second": secs > 9 ? secs : '0' + secs
                        }

                        return par
                    }
        }

        function delay(n) {
            return new Promise(function (resolve) {
                setTimeout(resolve, n * 1000);
            });
        }
        (function ($) {
            $.UrlParam = function (name) {
                //宣告正規表達式
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                /*
                 * window.location.search 獲取URL ?之後的參數(包含問號)
                 * substr(1) 獲取第一個字以後的字串(就是去除掉?號)
                 * match(reg) 用正規表達式檢查是否符合要查詢的參數
                */
                var r = window.location.search.substr(1).match(reg);
                //如果取出的參數存在則取出參數的值否則回穿null
                if (r != null) return (r[2]); return null;
            }
        })(jQuery);


        var TrainStationData;
        function TrainStationDataOpt(type, par1) {
            if (type === "get") {
                if ($("#req_header").text() !== "") {
                    let accesstoken = JSON.parse($("#req_header").text());
                    $.ajax({
                        url: `https://tdx.transportdata.tw/api/basic/v3/Rail/TRA/Station?%24format=JSON`,
                        method: "GET",
                        dataType: "json",
                        headers: {
                            "authorization": "Bearer " + accesstoken.access_token,
                        },
                        success: function (res) {
                            TrainStationData = res;
                            console.log(res);
                            App("loadingDismiss");
                        },
                        error: function (xhr, textStatus, thrownError) {
                            App("loadingFailed", "讀取台鐵車站資料");
                        }
                    })
                } else {
                    App("loadingFailed", "讀取台鐵車站資料");
                }
            } else if (type === "search") {

                $("#search-result").html("")
                for (i = 0; i < TrainStationData.Stations.length; i++) {

                    if (TrainStationData.Stations[i].StationName.Zh_tw.includes(par1) && par1 !== "") {
                        console.log(TrainStationData.Stations[i])
                        $("#search-result").append(`<a onclick="App('station','${TrainStationData.Stations[i].StationName.Zh_tw}','${TrainStationData.Stations[i].StationID}',${i})" href="#" class="list-group-item list-group-item-action">${TrainStationData.Stations[i].StationName.Zh_tw}(${TrainStationData.Stations[i].StationID})</a>`)
                    }
                }
                if ($("#search-result").html() == "") {
                    $("#search-result").append(`<a href="#" class="list-group-item list-group-item-action">無資料</a>`)

                }
            }

        }

        var 
        MRTStationData,
        MRTStationIndex;
        function MRTStationDataOpt(type, par1) {
            if (type === "get") {
                if ($("#req_header").text() !== "") {
                    let accesstoken = JSON.parse($("#req_header").text());
                    $.ajax({
                        url: `https://tdx.transportdata.tw/api/basic/v3/Rail/TRA/Station?%24format=JSON`,
                        method: "GET",
                        dataType: "json",
                        headers: {
                            "authorization": "Bearer " + accesstoken.access_token,
                        },
                        success: function (res) {
                            TrainStationData = res;
                            console.log(res);
                            App("loadingDismiss");
                        },
                        error: function (xhr, textStatus, thrownError) {
                            App("loadingFailed", "讀取捷運車站資料");
                        }
                    })
                } else {
                    App("loadingFailed", "讀取捷運車站資料");
                }
            } else if (type === "search") {

            }
        }
        function App(page, par1, par2, par3) {
            if (page === "loading" || page === "loadingFailed" || page === "loadingDismiss") {
                if (page === "loading") {
                    $("#loading-info").attr("class", "alert alert-info").text(`正在讀取資料集:${par1}`).show()
                } else if (page === "loadingFailed") {
                    $("#loading-info").attr("class", "alert alert-danger").text("發生錯誤，無法" + par1).show()
                } else {
                    $("#loading-info").hide()
                }
            } else {

                if (page === "TRAsearch") {
                    $("#header").text("台鐵車站 - 搜尋")
                    $("#main-content").html(`<div class="d-flex"><input type="text" class="form-control me-1" oninput="TrainStationDataOpt('search',$('#trainStationNameInput').val())" id="trainStationNameInput" placeholder="輸入台鐵車站名稱..."><button class="btn btn-primary bi bi-search" onclick="TrainStationDataOpt('search',$('#trainStationNameInput').val()) "></button></div><div class="list-group mt-2" id="search-result"></div>`)
                    TrainStationDataOpt("get")
                }
                else if (page === "MRTsearch") {
                    $("#header").text("捷運車站 - 搜尋")
                    $("#main-content").html(`<div class="d-flex"><input type="text" class="form-control me-1" oninput="TrainStationDataOpt('search',$('#trainStationNameInput').val())" id="trainStationNameInput" placeholder="輸入捷運站名..."><button class="btn btn-primary bi bi-search" onclick="TrainStationDataOpt('search',$('#trainStationNameInput').val()) "></button></div><div class="list-group mt-2" id="search-result"></div>`)
                    TrainStationDataOpt("get")
                }
                else if (page === "station") {
                    let stationLvL;
                    $("#header").text("台鐵 - " + par1 + "車站")
                    //['0: 特等', '1: 一等', '2: 二等', '3: 三等', '4: 簡易', '5: 招呼', '6: 號誌', 'A: 貨運', 'B: 基地', 'X: 非車']
                    if (TrainStationData.Stations[par3].StationClass == 0) {
                        stationLvL = "特等站"
                    } else if (TrainStationData.Stations[par3].StationClass == 1) {
                        stationLvL = "一等站"
                    } else if (TrainStationData.Stations[par3].StationClass == 2) {
                        stationLvL = "二等站"
                    } else if (TrainStationData.Stations[par3].StationClass == 3) {
                        stationLvL = "三等站"
                    }
                    else if (TrainStationData.Stations[par3].StationClass == 4) {
                        stationLvL = "簡易站"
                    }
                    else if (TrainStationData.Stations[par3].StationClass == 5) {
                        stationLvL = "招呼站"
                    }
                    else if (TrainStationData.Stations[par3].StationClass == 6) {
                        stationLvL = "號誌站"
                    }
                    else if (TrainStationData.Stations[par3].StationClass == "A") {
                        stationLvL = "貨運站"
                    }
                    else if (TrainStationData.Stations[par3].StationClass == "B") {
                        stationLvL = "基地"
                    }
                    else if (TrainStationData.Stations[par3].StationClass == "X") {
                        stationLvL = "非車站"
                    }
                    $("#main-content").html(`
                <div class="card"><div class="card-body"><h5 class="card-title">車站資料</h5><h6 class="card-subtitle mb-2 text-muted">${stationLvL}</h6><p class="card-text">地址 : ${TrainStationData.Stations[par3].StationAddress}<br>電話 : ${TrainStationData.Stations[par3].StationPhone}</p><a href="${TrainStationData.Stations[par3].StationURL}" target="_blank" class="card-link bi bi-box-arrow-up-right">詳細資料</a></div></div>
                `)
                }
                else if (page === "home") {
                    $("#header").text("大眾運輸查詢 - 首頁")
                    $("#main-content").html(`
                <div class="card m-1"><div class="card-body"><h5 class="card-title">台鐵</h5><h6 class="card-subtitle mb-2 text-muted">指定站點的台鐵列車資料</h6><p class="card-text"></p><button class="btn btn-primary"  onclick="App('TRAsearch')">開始查詢</button></div></div>
                <div class="card m-1"><div class="card-body"><h5 class="card-title">高鐵</h5><h6 class="card-subtitle mb-2 text-muted">指定站點的高鐵列車資料</h6><p class="card-text"></p><button class="btn btn-primary"  onclick="App('HSRsearch')">開始查詢</button></div></div>
                <div class="card m-1"><div class="card-body"><h5 class="card-title">捷運</h5><h6 class="card-subtitle mb-2 text-muted">指定站點的捷運列車動態</h6><p class="card-text text-danger">目前台中捷運不提供動態資料</p><button class="btn btn-primary"  onclick="App('MRTsearch')">開始查詢</button></div></div>
                <div class="card m-1"><div class="card-body"><h5 class="card-title">公路客運</h5><h6 class="card-subtitle mb-2 text-muted">公路客運即時動態</h6><p class="card-text"></p><button class="btn btn-primary"  onclick="App('InterBUSsearch')">開始查詢</button></div></div>
                <div class="card m-1"><div class="card-body"><h5 class="card-title">市區客運</h5><h6 class="card-subtitle mb-2 text-muted">市區客運即時動態</h6><p class="card-text"></p><button class="btn btn-primary"  onclick="App('CityBUSsearch')">開始查詢</button></div></div>
                <div class="card m-1"><div class="card-body"><h5 class="card-title">共享單車</h5><h6 class="card-subtitle mb-2 text-muted">共享單車即時剩餘位置資料</h6><p class="card-text"></p><button class="btn btn-primary"  onclick="App('BIKEsearch')">開始查詢</button></div></div>
                `)
                }
                else {
                    $("#header").text("找不到頁面")
                    $("#main-content").html(`
                <h1>404</h1>
                <p>找不到這個頁面</p>
                請<a href="#" onclick="App('home')">回到首頁</a>
                `)
                }
            }
        }



        var tdxLogin = {
            grant_type: "client_credentials",
            client_id: "jerry20200815-905e4c2d-f4f9-42dd",
            client_secret: "df5c085e-f262-4258-b1d6-518e40138f71"
        };

        $.ajax({
            type: "POST",
            url: "https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token",
            crossDomain: true,
            dataType: 'JSON',
            data: tdxLogin,
            async: false,
            success: function (data) {
                //   console.log(data);
                $("#req_header").text(JSON.stringify(data))
                App("loadingDismiss")
            },
            error: function (xhr, textStatus, thrownError) {
                App("loadingFailed", "連線到伺服器")
            }
        });


        if ($.UrlParam("type") !== null) {

        } else {
            App("home")
        }



        

    </script>
</body>

</html>